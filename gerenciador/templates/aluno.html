<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aluno</title>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .btn-back {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 10px 20px;
            border: 2px solid white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-back:hover {
            background: white;
            color: #667eea;
        }

        h1 {
            color: white;
            text-align: center;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-right: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-delete {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .btn-delete:hover {
            transform: translateY(-2px);
        }

        .error {
            background: #f5576c;
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .success {
            background: #4ade80;
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .btn-pdf {
            background: #ff5252;
            color: white;
            padding: 10px 14px;
            border-radius: 8px;
            text-decoration: none;
            font-size: 14px;
            font-weight: 600;
            transition: 0.2s;
        }

        .btn-pdf:hover {
            background: #ff1744;
        }

        .header-enderecos {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .form-endereco {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 8px;
        }

        .form-endereco.show {
            display: block;
        }

        .enderecos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .endereco-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .endereco-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
        }

        .endereco-card h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.3em;
        }

        .endereco-info {
            color: #555;
            margin: 5px 0;
            font-size: 0.95em;
        }

        .endereco-info strong {
            color: #333;
        }
        .btn-delete {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
            transition: transform 0.2s;
        }

        .btn-delete:hover {
            transform: scale(1.05);
        }




    </style>

</head>
<body>

<div class="container">

    <a class="btn-back" id="voltar-btn">‚Üê Voltar</a>

    <h1>Dados do Aluno</h1>

    <div id="mensagem"></div>

    <div class="card">
        <div class="form-group">
            <label>Nome</label>
            <input type="text" id="nome">
        </div>

        <div class="form-group">
            <label>Telefone</label>
            <input type="text" id="telefone">
        </div>

        <div class="form-group">
            <label>Email</label>
            <input type="email" id="email">
        </div>

        <div class="form-group">
            <label>Telefone do Respons√°vel</label>
            <input type="text" id="telefone_pai">
        </div>
        
        <button class="btn" onclick="salvar()">Salvar Altera√ß√µes</button>
        <button class="btn btn-delete" onclick="deletarAluno()">Excluir Aluno</button>
    </div>

    <div class="card">
        <div class="header-enderecos">
            <h2 style="color: #333;">Endere√ßos</h2>
            <button class="btn" onclick="toggleFormEndereco()">+ Adicionar Endere√ßo</button>
        </div>
        
        <div id="form-endereco" class="form-endereco">
            <h3 style="margin-bottom: 15px; color: #333;">Novo Endere√ßo</h3>
            <div class="form-group">
                <label>Estado</label>
                <input type="text" id="estado">
            </div>
            <div class="form-group">
                <label>Cidade</label>
                <input type="text" id="cidade">
            </div>
            <div class="form-group">
                <label>Bairro</label>
                <input type="text" id="bairro">
            </div>
            <div class="form-group">
                <label>Rua</label>
                <input type="text" id="rua">
            </div>
            <div class="form-group">
                <label>Casa/N√∫mero</label>
                <input type="text" id="casa">
            </div>
            <button class="btn" onclick="adicionarEndereco()">Salvar Endere√ßo</button>
            <button class="btn btn-delete" onclick="toggleFormEndereco()">Cancelar</button>
        </div>

        <div id="loading" class="loading">Carregando Endere√ßos...</div>
        <div id="enderecosLista" class="enderecos-grid"></div>
    </div>

    <div class="card">
        <h2>Avalia√ß√µes</h2>
        <div id="avaliacoes-lista"></div>

        <h3>Adicionar Avalia√ß√£o</h3>
        <div class="form-group">
            <label>Disciplina</label>
            <select id="disciplina"></select>
        </div>
        <div class="form-group">
            <label>Avalia√ß√£o</label>
            <input type="text" id="avaliacao_nome">
        </div>
        <div class="form-group">
            <label>Nota</label>
            <input type="number" id="nota" step="0.01">
        </div>
        <div class="form-group">
            <label>Data</label>
            <input type="date" id="data_avaliacao">
        </div>
        <div class="form-group">
            <label>PDF da Prova (opcional)</label>
            <input type="file" id="prova_pdf" accept="application/pdf">
        </div>
        <button class="btn" onclick="adicionarAvaliacao()">Adicionar</button>
    </div>

</div>
    
<script>
    document.addEventListener('DOMContentLoaded', () => {
        carregarEnderecos();
        carregarAluno();
        carregarDisciplinas();
        carregarAvaliacoes();
    });

    // --- Obter IDs da URL ---
    const urlParts = window.location.pathname.split('/').filter(Boolean);
    const escola_id = urlParts[1];
    const turma_id = urlParts[3];
    const aluno_id = urlParts[5];

    document.getElementById("voltar-btn").href =
        `/escolas/${escola_id}/turmas/${turma_id}`;

    const nomeInput = document.getElementById("nome");
    const telefoneInput = document.getElementById("telefone");
    const emailInput = document.getElementById("email");
    const telefonePaiInput = document.getElementById("telefone_pai");
    const msg = document.getElementById("mensagem");

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    async function carregarAluno() {
        try {
            const resp = await fetch(`/api/alunos/${aluno_id}/`);

            if (!resp.ok) throw new Error("Erro ao carregar aluno");

            const aluno = await resp.json();

            nomeInput.value = aluno.nome || "";
            telefoneInput.value = aluno.telefone || "";
            emailInput.value = aluno.email || "";
            telefonePaiInput.value = aluno.telefone_pai || "";

        } catch (e) {
            msg.innerHTML = `<div class="error">${e.message}</div>`;
        }
    }

    // --- Salvar altera√ß√µes ---
    async function salvar() {
        msg.innerHTML = '';
        const csrftoken = getCookie('csrftoken');
        const data = {
            nome: nomeInput.value,
            telefone: telefoneInput.value,
            email: emailInput.value,
            telefone_pai: telefonePaiInput.value
        };

        try {
            const resp = await fetch(`/api/alunos/${aluno_id}/`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify(data)
            });

            if (!resp.ok) throw new Error("Erro ao salvar altera√ß√µes");
            msg.innerHTML = `<div class="success">Altera√ß√µes salvas com sucesso!</div>`;
        } catch (e) {
            msg.innerHTML = `<div class="error">${e.message}</div>`;
        }
    }

    // --- Deletar aluno ---
    async function deletarAluno() {
        if (!confirm("Deseja realmente excluir este aluno?")) return;

        try {
            const resp = await fetch(`/api/alunos/${aluno_id}/`, {
                method: "DELETE"
            });

            if (!resp.ok) throw new Error("Erro ao excluir aluno");

            window.location.href = `/escolas/${escola_id}/turmas/${turma_id}/alunos`;

        } catch (e) {
            msg.innerHTML = `<div class="error">${e.message}</div>`;
        }
    }

    // --- Toggle formul√°rio de endere√ßo ---
    function toggleFormEndereco() {
        const form = document.getElementById('form-endereco');
        form.classList.toggle('show');
        
        // Limpar campos se estiver fechando
        if (!form.classList.contains('show')) {
            document.getElementById('estado').value = '';
            document.getElementById('cidade').value = '';
            document.getElementById('bairro').value = '';
            document.getElementById('rua').value = '';
            document.getElementById('casa').value = '';
        }
    }

    // --- Adicionar novo endere√ßo ---
    async function adicionarEndereco() {
        const csrftoken = getCookie('csrftoken');
        const data = {
            //aluno_id: aluno_id,
            estado: document.getElementById('estado').value,
            cidade: document.getElementById('cidade').value,
            bairro: document.getElementById('bairro').value,
            rua: document.getElementById('rua').value,
            casa: document.getElementById('casa').value
        };

        try {
            const resp = await fetch(`/api/alunos/${aluno_id}/enderecos`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify(data)
            });

            if (!resp.ok) throw new Error("Erro ao adicionar endere√ßo");
            
            msg.innerHTML = `<div class="success">Endere√ßo adicionado com sucesso!</div>`;
            toggleFormEndereco();
            carregarEnderecos();
        } catch (e) {
            msg.innerHTML = `<div class="error">${e.message}</div>`;
        }
    }

    async function carregarEnderecos() {
        const loading = document.getElementById('loading');
        const lista = document.getElementById('enderecosLista');
        
        try {
            loading.style.display = 'block';
            lista.innerHTML = '';
            
            const response = await fetch(`/api/alunos/${aluno_id}/enderecos`);
            
            if (!response.ok) {
                throw new Error('Erro ao carregar endere√ßos');
            }
            
            const enderecos = await response.json();
            loading.style.display = 'none';
            
            if (enderecos.length === 0) {
                lista.innerHTML = '<p style="text-align: center; color: #666;">Nenhum endere√ßo cadastrado ainda.</p>';
                return;
            }
            
            enderecos.forEach(endereco => {
                const card = criarCardEndereco(endereco);
                lista.appendChild(card);
            });
            
        } catch (error) {
            loading.style.display = 'none';
            msg.innerHTML = `<div class="error">Erro ao carregar endere√ßos: ${error.message}</div>`;
            console.error('Erro:', error);
        }
    }

    function criarCardEndereco(endereco) {
        const div = document.createElement('div');
        div.className = 'endereco-card';
        div.style.cursor = 'pointer';
        div.innerHTML = `
            <h3>${endereco.estado}</h3>
            <p class="endereco-info"><strong>Cidade:</strong> ${endereco.cidade}</p>
            <p class="endereco-info"><strong>Bairro:</strong> ${endereco.bairro}</p>
            <p class="endereco-info"><strong>Rua:</strong> ${endereco.rua}</p>
            <p class="endereco-info"><strong>Casa:</strong> ${endereco.casa}</p>
            <button class="btn-delete" onclick="event.stopPropagation();deletarEndereco(${endereco.endereco_id})">üóëÔ∏è Deletar</button>
            <button class="btn-delete" onclick="event.stopPropagation();MudarEndereco(${endereco.endereco_id})">Atualizar</button>
        `;
        
        return div;
    }

    async function deletarEndereco(endereco_id) {
        if (!confirm("Deseja realmente excluir este endere√ßo?")) return;

        try {
            const resp = await fetch(`/api/enderecos/${aluno_id}/${endereco_id}/`, {
                method: "DELETE"
            });

            if (!resp.ok) throw new Error("Erro ao excluir endere√ßo");

            msg.innerHTML = `<div class="success">Endere√ßo exclu√≠do com sucesso!</div>`;
            carregarEnderecos();

        } catch (e) {
            msg.innerHTML = `<div class="error">${e.message}</div>`;
        }
    }

    async function carregarDisciplinas() {
        try {
            const resp = await fetch('/api/disciplinas/');
            if (!resp.ok) throw new Error("Erro ao carregar disciplinas");

            const disciplinas = await resp.json();
            const select = document.getElementById('disciplina');
            select.innerHTML = '';
            disciplinas.forEach(d => {
                const option = document.createElement('option');
                option.value = d.disciplina_id;
                option.textContent = d.nome;
                select.appendChild(option);
            });
        } catch(e) { console.error(e); }
    }

    async function carregarAvaliacoes() {
        try {
            const matricula_id = await buscarMatriculaId();
            const resp = await fetch(`/api/avaliacoes/${matricula_id}/`);

            if (!resp.ok) throw new Error("Erro ao carregar avalia√ß√µes");

            const avaliacoes = await resp.json();

            const container = document.getElementById('avaliacoes-lista');
            container.innerHTML = '';

            avaliacoes.forEach(a => {
                const card = document.createElement('div');
                card.className = 'card';

                const p = document.createElement('p');
                p.innerHTML = `<strong>${a.disciplina}</strong> - ${a.avaliacao}: ${a.nota} (${a.data_avaliacao || ''})`;
                card.appendChild(p);

                if (a.prova_pdf) {
                    const pdfData = a.prova_pdf.split(',')[1];
                    const byteCharacters = atob(pdfData);
                    const byteNumbers = new Array(byteCharacters.length);
                    for (let i = 0; i < byteCharacters.length; i++) {
                        byteNumbers[i] = byteCharacters.charCodeAt(i);
                    }
                    const byteArray = new Uint8Array(byteNumbers);
                    const blob = new Blob([byteArray], {type: "application/pdf"});
                    const url = URL.createObjectURL(blob);

                    const btn = document.createElement('a');
                    btn.href = url;
                    btn.target = "_blank";
                    btn.textContent = "üìÑ Visualizar PDF";
                    btn.className = "btn btn-pdf";
                    btn.style.marginRight = "10px";
                    card.appendChild(btn);
                } else {
                    const span = document.createElement('span');
                    span.textContent = "Nenhum PDF enviado";
                    span.style.color = "#888";
                    span.style.fontSize = "14px";
                    card.appendChild(span);
                }

                const btnDel = document.createElement('button');
                btnDel.className = 'btn btn-delete';
                btnDel.textContent = 'Excluir';
                btnDel.onclick = () => deletarAvaliacao(a.matricula_id, a.disciplina_id, a.avaliacao);
                card.appendChild(btnDel);

                container.appendChild(card);
            });
        } catch(e) {
            console.error(e);
            msg.innerHTML = `<div class="error">${e.message}</div>`;
        }
    }

    async function adicionarAvaliacao() {
        const matricula_id = await buscarMatriculaId();
        const disciplina_id = document.getElementById('disciplina').value;
        const avaliacao_nome = document.getElementById('avaliacao_nome').value;
        const nota = document.getElementById('nota').value;
        const data_avaliacao = document.getElementById('data_avaliacao').value;
        const pdfFile = document.getElementById('prova_pdf').files[0];

        const formData = new FormData();
        formData.append("disciplina_id", disciplina_id);
        formData.append("avaliacao", avaliacao_nome);
        formData.append("nota", nota);
        formData.append("data_avaliacao", data_avaliacao);
        if (pdfFile) {
            formData.append("prova", pdfFile);
        }

        try {
            const resp = await fetch(`/api/avaliacoes/${matricula_id}/`, {
                method: 'POST',
                body: formData
            });
            if(!resp.ok) throw new Error('Erro ao adicionar avalia√ß√£o');
            carregarAvaliacoes();
        } catch(e) { console.error(e); }
    }

    async function buscarMatriculaId() {
        try {
            const resp = await fetch(`/api/turmas/${turma_id}/matriculas/`);
            if (!resp.ok) throw new Error("Erro ao buscar matr√≠culas");

            const matriculas = await resp.json();
            const matricula = matriculas.find(m => m.aluno_id == aluno_id);
            if (!matricula) throw new Error("Aluno n√£o matriculado nesta turma");

            return matricula.matricula_id;
        } catch(e) {
            msg.innerHTML = `<div class="error">${e.message}</div>`;
        }
    }

    async function deletarAvaliacao(matricula_id, disciplina_id, avaliacao_nome) {
        if(!confirm("Deseja realmente excluir esta avalia√ß√£o?")) return;
        try {
            const resp = await fetch(`/api/avaliacoes/${matricula_id}/${disciplina_id}/${avaliacao_nome}/`, {
                method: 'DELETE'
            });
            if (!resp.ok) throw new Error("Erro ao excluir avalia√ß√£o");
            carregarAvaliacoes();
        } catch(e) { console.error(e); }
    }

</script>

</body>
</html> 